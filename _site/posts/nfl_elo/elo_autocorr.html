<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.600">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>quarto-blog - Untitled</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">quarto-blog</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Untitled</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="autocorrelation-in-elo-ratings" class="level2">
<h2 class="anchored" data-anchor-id="autocorrelation-in-elo-ratings">Autocorrelation in Elo ratings</h2>
<p>FiveThirtyEight uses the following formula for their NFL Elo ratings:</p>
<p><span class="math display">\[
R_{Team_{A}}^{k+1} = R_{Team_{A}}^{k} + K \cdot M(mov) \cdot A(x) \cdot (S_{Team_{A} \; Team_{B}} - \sigma(x))
\]</span></p>
<p>where <span class="math inline">\(mov\)</span> is the game’s margin of victory, <span class="math inline">\(x = R_{Team_{A}}^{k} - R_{Team_{B}}^{k}\)</span>, and</p>
<p><span class="math display">\[
\Large
\begin{align*}
M(mov) &amp;= \ln (|mov|+1) \\
A(x) &amp;= \frac{2.2}{2.2-0.001(-1)^{S_{Team_{A} \; Team_{B}}} x} \\
&amp; = \frac{1}{1-(-1)^{S_{Team_{A} \; Team_{B}}}\frac{x}{2200}} \\
S_{Team_{A} \; Team_{B}} &amp;= \begin{cases} 1 &amp; Team_{A} \text{ wins} \\ 0.5 &amp; Team_{A} \text{ ties} \\ 0 &amp; Team_{A} \text{ loses}\end{cases} \\
\sigma(x) &amp;= \frac{1}{1+10^{-x/400}}
\end{align*}
\]</span></p>
<p>My question is the specific justification for the <span class="math display">\[A(x)\]</span> term:</p>
<ul>
<li><strong>why this form</strong>, and</li>
<li><strong>why those numbers.</strong></li>
</ul>
<p>I’m looking for more than a layman’s explanation, which 538 already offers and is the typical answer <a href="https://stats.stackexchange.com/questions/168047/accounting-for-autocorrelation-in-margin-based-elo-ratings">elsewhere</a>. (Although <a href="https://andr3w321.com/a-note-on-autocorrelation/">this post</a> goes a bit deeper.)</p>
</section>
<section id="quick-intuition" class="level2">
<h2 class="anchored" data-anchor-id="quick-intuition">Quick intuition</h2>
<p>So first you should buy off on the idea that given Team <span class="math display">\[i\]</span>’s current rating is <span class="math display">\[R_i\]</span>, we should <em>expect</em> its rating after the current game to still be <span class="math display">\[R_i\]</span>. For example, we shouldn’t ever <em>expect</em> Team <span class="math display">\[i\]</span>’s rating to increase, because if we did, <a href="https://fivethirtyeight.com/features/introducing-nfl-elo-ratings">“we should have rated them higher to begin with”</a>!</p>
<p>Put in statistical language, this is the statement that we want <span class="math display">\[\mathbb{E}[R_i^{k+1}\vert\text{all prev ratings}] = R_i^k\]</span>, but more on that in a second.</p>
</section>
<section id="the-typical-explanation" class="level2">
<h2 class="anchored" data-anchor-id="the-typical-explanation">The typical explanation</h2>
<p>So <span class="math inline">\(A(x)\)</span>, which again is</p>
<p><span class="math display">\[
\begin{equation}
A(x) = \frac{1}{1-(-1)^{S_{ij}}\frac{x}{2200}}
\label{eq:autocorr}
\end{equation}
\]</span></p>
<p>is intended to correct for over- or under-inflation of ratings in the model. We see the function is designed so that</p>
<ul>
<li>If Team <span class="math display">\[i\]</span> is the favorite (<span class="math display">\[x&gt;0\]</span>), a loss is upweighted (<span class="math display">\[A(x)&gt;0\]</span>) and a win is downweighted (<span class="math display">\[A(x)&lt;0\]</span>).</li>
<li>If Team <span class="math display">\[i\]</span> is the underdog (<span class="math display">\[x&lt;0\]</span>), the opposite.</li>
</ul>
<p>So this <em>seems</em> like it would correct for over-inflation of rating due to a heavy favorite, and vice-versa for a big underdog.</p>
<p>However, we are left with the questions: why achieve it <em>in this way</em>? And why use the denominator <span class="math display">\[d=2200\]</span>?</p>
</section>
<section id="gettin-stats-y" class="level2">
<h2 class="anchored" data-anchor-id="gettin-stats-y">Gettin stats-y</h2>
<p>We may interpret Elo ratings as a time series where each new rating depends only on the previous rating, plus some “noise.” More specifically, under this interpretation Elo assumes each team has some true rating, its mean, about which it is constantly fluctuating. This is called an autoregressive model, in our case AR(1). We are <em>also</em> assuming the team’s ratings are <strong>stationary</strong>, meaning (loosely) the mean stays the same over time.</p>
<p>(By the way, this is a different interpretation than the <a href="https://stmorse.github.io/journal/Elo.html">connection to SGD</a> I wrote about before, but SGD and AR(1) are, in some sense, the same thing.)</p>
<p><a href="https://www.gilgamath.com/elo-distribution">Skipping some details</a>, (I think) this all amounts to needing the next observation in the time series to, in expectation, equal our current observation. That is, <span class="math display">\[\mathbb{E}[R_i^{k+1}\vert\text{prev ratings}] = R_i^k\]</span>.</p>
<p>The fact that we’re fretting about a correction term at all arises because of the margin-of-victory <span class="math display">\[M(z)\]</span> term we are including. This isn’t part of the “classical” Elo rating scheme, and it’s messing everything up! Without it, we have</p>
<p><span class="math display">\[
\begin{align*}
\mathbb{E}[R_k^{k+1}] &amp;= \mathbb{E}[R_i^k] + \mathbb{E}[k(S_{ij}-\sigma(x))] \\
&amp;= R_i^k + k(\mathbb{E}[S_{ij}] - \sigma(x)) \\
&amp;= R_i^k
\end{align*}
\]</span></p>
<p>which is just fine.</p>
<p>Now, including a margin-of-victory term <span class="math display">\[M(z)\]</span>, we need</p>
<p><span class="math display">\[
\mathbb{E}[M(z)\cdot A(x) \cdot (S_{ij} - \sigma(x))] = 0
\]</span></p>
<p>which, computing expectation over all possible game outcomes as encoded in <span class="math display">\[z\]</span>, given <span class="math display">\[R_i^k\]</span> and <span class="math display">\[R_j^k\]</span>, implies</p>
<p><span class="math display">\[
\int_{-\infty}^0 M(z) A(x) (-\sigma(x)) \text{Pr}(z) \ dz + \int_0^{\infty} M(z) A(x) (1-\sigma(x)) \text{Pr}(z) \ dz = 0
\]</span></p>
<p>over some distribution for the margin <span class="math display">\[z\]</span>. Rearranging, we get</p>
<p><span class="math display">\[
\begin{equation}
\frac{A(x; i \text{ win})}{A(x; i \text{ lose})} = \frac{\sigma(x)}{1-\sigma(x)} \cdot \frac{\mathbb{E}[M(z)|i \text{ lose}]}{\mathbb{E}[M(z)|i \text{ wins}]}
\label{eq:goal}
\end{equation}
\]</span></p>
<p>and we want some <span class="math display">\[A(x)\]</span> so this holds for any Elo delta <span class="math display">\[x\]</span>.</p>
<p>We should be able to interpolate some function for the expected <span class="math display">\[M(z)\]</span>’s, and then if we are satisfied with our functional form for <span class="math display">\[A(x)\]</span>, solve for the denominator <span class="math display">\[d\]</span>.</p>
<p>Let’s try it.</p>
</section>
<section id="in-search-of-d" class="level2">
<h2 class="anchored" data-anchor-id="in-search-of-d">In search of d</h2>
<p>We need to (1) work out the empirical conditional expectations for <span class="math display">\[M(z)\]</span>, then (2) approximate them with functions, and finally (3) solve for <span class="math display">\[d\]</span> in terms of those functions.</p>
<p>We can easily* pull boxscores, Elo ratings, and plot the mean <span class="math display">\[M(z)\]</span>’s. (*really not that easy, but <a href="#code">see code</a> at the bottom of this post.)</p>
<p>Here’s the expected <span class="math display">\[M(z)\]</span> given various Elo rating deltas, based on the past 18 NFL seasons.</p>
<p>Nice! So the empirical (conditional) expectations we’re after are both reasonably approximated by linear functions:</p>
<p><span class="math display">\[
\begin{align*}
\mathbb{E}[M(z)|i \text{ win}] &amp;\approx \frac{x}{1000} + 2.2 \\
\mathbb{E}[M(z)|i \text{ lose}] &amp;\approx -\frac{x}{1000} + 2.2
\end{align*}
\]</span></p>
<p>(Let the reader note: the slope and intercept here are what you might call “eyeball” estimates, although they are quite close to an OLS estimate.)</p>
<p>Returning to Eq. <span class="math inline">\(\eqref{eq:goal}\)</span> and using our satisfying functional form for <span class="math display">\[A(x)\]</span> from Eq. <span class="math inline">\(\eqref{eq:autocorr}\)</span>, we (almost) have</p>
<p><span class="math display">\[
\begin{align*}
\frac{A(x; i \text{ wins})}{A(x; i \text{ lose})} &amp;=
\frac{\mathbb{E}[M(z)|i \text{ wins}]}{\mathbb{E}[M(z)|i \text{ lose}]} \\
\frac{1-x/d}{1+x/d} &amp;\approx \frac{-x/1000 + 2.2}{x/1000 + 2.2}
\end{align*}
\]</span></p>
<p>which gives <span class="math display">\[d=2200\]</span>. Voila!</p>
<p><strong>To do.</strong> To get here, we had to ignore the <span class="math display">\[\sigma/(1-\sigma)=10^{x/400}\]</span> term in Eq. <span class="math inline">\(\eqref{eq:goal}\)</span>. There might be a way to rewrite the expected <span class="math display">\[M(z)\]</span>’s in a way they still fit the data and cancel this other term out, but if not, I’m not sure.</p>
<hr>
</section>
<section id="code" class="level2">
<h2 class="anchored" data-anchor-id="code">Code</h2>
<p>Fortunately we can make heavy use of 538’s public NFL data.</p>
<p>First some imports to get us running in a Jupyter notebook:</p>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>Then we load the data, extract just the last few seasons, and run the desired stats:</p>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>box <span class="op">=</span> pd.read_csv(<span class="st">'https://raw.githubusercontent.com/fivethirtyeight/nfl-elo-game/master/data/nfl_games.csv'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># convert date to datetime</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>box[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(box[<span class="st">'date'</span>])</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># grab since ____ season</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>box <span class="op">=</span> (box[box[<span class="st">'date'</span>] <span class="op">&gt;</span> <span class="st">'2003-08-01'</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>       .reset_index()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>       .drop([<span class="st">'index'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>       .copy())</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> box.shape[<span class="dv">0</span>]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>elodiffs <span class="op">=</span> np.zeros(n)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>pdiffs   <span class="op">=</span> np.zeros(n)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, row <span class="kw">in</span> box.iterrows():</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    elodiffs[i] <span class="op">=</span> row[<span class="st">'elo1'</span>] <span class="op">-</span> row[<span class="st">'elo2'</span>] <span class="op">+</span> (<span class="dv">0</span> <span class="cf">if</span> row[<span class="st">'neutral'</span>]<span class="op">==</span><span class="dv">1</span> <span class="cf">else</span> <span class="dv">65</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    pdiffs[i]   <span class="op">=</span> row[<span class="st">'score1'</span>] <span class="op">-</span> row[<span class="st">'score2'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>We could do something like a <code>pdiffs</code> vs.&nbsp;<code>elodiffs</code> plot with Seaborn at this point, perhaps a <code>jointplot</code> like this …</p>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sns.jointplot(elodiffs <span class="op">/</span> <span class="dv">25</span>, pdiffs, ylim<span class="op">=</span>(<span class="op">-</span><span class="dv">50</span>,<span class="dv">50</span>), kind<span class="op">=</span><span class="st">'hex'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>which is quite exciting. But what we’re really interested in is the mean MOV function distributions, which is the much less pretty:</p>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">300</span>,<span class="dv">400</span>,<span class="dv">10</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> g1(x):</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">/</span><span class="dv">1000</span>) <span class="op">+</span> <span class="fl">2.2</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> g2(x):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>x<span class="op">/</span><span class="dv">1000</span> <span class="op">+</span> <span class="fl">2.2</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>ax.plot(ed, mw, <span class="st">'ko-'</span>, label<span class="op">=</span><span class="st">'Win'</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>ax.plot(xs, g1(xs), <span class="st">'k--'</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>ax.plot(ed, ml, <span class="st">'co-'</span>, label<span class="op">=</span><span class="st">'Loss'</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>ax.plot(xs, g2(xs), <span class="st">'c--'</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r'$R_i - R_j$'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r'Mean $M(z)$'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb5" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Untitled"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: true</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight: true</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: github</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Autocorrelation in Elo ratings</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>FiveThirtyEight uses the following formula for their NFL Elo ratings:</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>R_{Team_{A}}^{k+1} = R_{Team_{A}}^{k} + K \cdot M(mov) \cdot A(x) \cdot (S_{Team_{A} \; Team_{B}} - \sigma(x))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>where $mov$ is the game's margin of victory, $x = R_{Team_{A}}^{k} - R_{Team_{B}}^{k}$, and</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>\Large </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>M(mov) &amp;= \ln (|mov|+1) <span class="sc">\\</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>A(x) &amp;= \frac{2.2}{2.2-0.001(-1)^{S_{Team_{A} \; Team_{B}}} x} <span class="sc">\\</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>&amp; = \frac{1}{1-(-1)^{S_{Team_{A} \; Team_{B}}}\frac{x}{2200}} <span class="sc">\\</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>S_{Team_{A} \; Team_{B}} &amp;= \begin{cases} 1 &amp; Team_{A} \text{ wins} <span class="sc">\\</span> 0.5 &amp; Team_{A} \text{ ties} <span class="sc">\\</span> 0 &amp; Team_{A} \text{ loses}\end{cases} <span class="sc">\\</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>\sigma(x) &amp;= \frac{1}{1+10^{-x/400}}</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>My question is the specific justification for the $$A(x)$$ term: </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**why this form**, and </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**why those numbers.**  </span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>I'm looking for more than a layman's explanation, which 538 already offers and is the typical answer <span class="co">[</span><span class="ot">elsewhere</span><span class="co">](https://stats.stackexchange.com/questions/168047/accounting-for-autocorrelation-in-margin-based-elo-ratings)</span>.  (Although <span class="co">[</span><span class="ot">this post</span><span class="co">](https://andr3w321.com/a-note-on-autocorrelation/)</span> goes a bit deeper.)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quick intuition</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>So first you should buy off on the idea that given Team $$i$$'s current rating is $$R_i$$, we should *expect* its rating after the current game to still be $$R_i$$.  For example, we shouldn't ever *expect* Team $$i$$'s rating to increase, because if we did, <span class="co">[</span><span class="ot">"we should have rated them higher to begin with"</span><span class="co">](https://fivethirtyeight.com/features/introducing-nfl-elo-ratings)</span>!</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>Put in statistical language, this is the statement that we want $$\mathbb{E}<span class="co">[</span><span class="ot">R_i^{k+1}\vert\text{all prev ratings}</span><span class="co">]</span> = R_i^k$$, but more on that in a second.</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="fu">## The typical explanation</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>So $A(x)$, which again is</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>A(x) = \frac{1}{1-(-1)^{S_{ij}}\frac{x}{2200}}</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>\label{eq:autocorr}</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>is intended to correct for over- or under-inflation of ratings in the model.  We see the function is designed so that</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If Team $$i$$ is the favorite ($$x&gt;0$$), a loss is upweighted ($$A(x)&gt;0$$) and a win is downweighted ($$A(x)&lt;0$$).</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If Team $$i$$ is the underdog ($$x&lt;0$$), the opposite.</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>So this *seems* like it would correct for over-inflation of rating due to a heavy favorite, and vice-versa for a big underdog.</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>However, we are left with the questions: why achieve it *in this way*? And why use the denominator $$d=2200$$?</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="fu">## Gettin stats-y</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>We may interpret Elo ratings as a time series where each new rating depends only on the previous rating, plus some "noise."  More specifically, under this interpretation Elo assumes each team has some true rating, its mean, about which it is constantly fluctuating.  This is called an autoregressive model, in our case AR(1).  We are *also* assuming the team's ratings are **stationary**, meaning (loosely) the mean stays the same over time.</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>(By the way, this is a different interpretation than the <span class="co">[</span><span class="ot">connection to SGD</span><span class="co">](https://stmorse.github.io/journal/Elo.html)</span> I wrote about before, but SGD and AR(1) are, in some sense, the same thing.)</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Skipping some details</span><span class="co">](https://www.gilgamath.com/elo-distribution)</span>, (I think) this all amounts to needing the next observation in the time series to, in expectation, equal our current observation.  That is, $$\mathbb{E}<span class="co">[</span><span class="ot">R_i^{k+1}\vert\text{prev ratings}</span><span class="co">]</span> = R_i^k$$.</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>The fact that we're fretting about a correction term at all arises because of the margin-of-victory $$M(z)$$ term we are including.  This isn't part of the "classical" Elo rating scheme, and it's messing everything up!  Without it, we have</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>\mathbb{E}<span class="co">[</span><span class="ot">R_k^{k+1}</span><span class="co">]</span> &amp;= \mathbb{E}<span class="co">[</span><span class="ot">R_i^k</span><span class="co">]</span> + \mathbb{E}<span class="co">[</span><span class="ot">k(S_{ij}-\sigma(x))</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>&amp;= R_i^k + k(\mathbb{E}<span class="co">[</span><span class="ot">S_{ij}</span><span class="co">]</span> - \sigma(x)) <span class="sc">\\</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>&amp;= R_i^k </span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>which is just fine.    </span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>Now, including a margin-of-victory term $$M(z)$$, we need</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>\mathbb{E}<span class="co">[</span><span class="ot">M(z)\cdot A(x) \cdot (S_{ij} - \sigma(x))</span><span class="co">]</span> = 0</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>which, computing expectation over all possible game outcomes as encoded in $$z$$, given $$R_i^k$$ and $$R_j^k$$, implies</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>\int_{-\infty}^0 M(z) A(x) (-\sigma(x)) \text{Pr}(z) \ dz + \int_0^{\infty} M(z) A(x) (1-\sigma(x)) \text{Pr}(z) \ dz = 0</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>over some distribution for the margin $$z$$.  Rearranging, we get</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>\frac{A(x; i \text{ win})}{A(x; i \text{ lose})} = \frac{\sigma(x)}{1-\sigma(x)} \cdot \frac{\mathbb{E}<span class="co">[</span><span class="ot">M(z)|i \text{ lose}</span><span class="co">]</span>}{\mathbb{E}<span class="co">[</span><span class="ot">M(z)|i \text{ wins}</span><span class="co">]</span>}</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>\label{eq:goal}</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>and we want some $$A(x)$$ so this holds for any Elo delta $$x$$.</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>We should be able to interpolate some function for the expected $$M(z)$$'s, and then if we are satisfied with our functional form for $$A(x)$$, solve for the denominator $$d$$.</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>Let's try it.</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a><span class="fu">## In search of d</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>We need to (1) work out the empirical conditional expectations for $$M(z)$$, then (2) approximate them with functions, and finally (3) solve for $$d$$ in terms of those functions.  </span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>We can easily* pull boxscores, Elo ratings, and plot the mean $$M(z)$$'s.  (*really not that easy, but <span class="co">[</span><span class="ot">see code</span><span class="co">](#code)</span> at the bottom of this post.)</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>Here's the expected $$M(z)$$ given various Elo rating deltas, based on the past 18 NFL seasons.</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>Nice!  So the empirical (conditional) expectations we're after are both reasonably approximated by linear functions:</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>\mathbb{E}<span class="co">[</span><span class="ot">M(z)|i \text{ win}</span><span class="co">]</span> &amp;\approx \frac{x}{1000} + 2.2 <span class="sc">\\</span></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>\mathbb{E}<span class="co">[</span><span class="ot">M(z)|i \text{ lose}</span><span class="co">]</span> &amp;\approx -\frac{x}{1000} + 2.2</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>(Let the reader note: the slope and intercept here are what you might call "eyeball" estimates, although they are quite close to an OLS estimate.)</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>Returning to Eq. \eqref{eq:goal} and using our satisfying functional form for $$A(x)$$ from Eq. \eqref{eq:autocorr}, we (almost) have</span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>\frac{A(x; i \text{ wins})}{A(x; i \text{ lose})} &amp;= </span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>\frac{\mathbb{E}<span class="co">[</span><span class="ot">M(z)|i \text{ wins}</span><span class="co">]</span>}{\mathbb{E}<span class="co">[</span><span class="ot">M(z)|i \text{ lose}</span><span class="co">]</span>} <span class="sc">\\</span></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>\frac{1-x/d}{1+x/d} &amp;\approx \frac{-x/1000 + 2.2}{x/1000 + 2.2}</span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>which gives $$d=2200$$.  Voila!</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>**To do.** To get here, we had to ignore the $$\sigma/(1-\sigma)=10^{x/400}$$ term in Eq. \eqref{eq:goal}.  There might be a way to rewrite the expected $$M(z)$$'s in a way they still fit the data and cancel this other term out, but if not, I'm not sure.</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr&gt;</span></span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a><span class="fu">## Code</span></span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>Fortunately we can make heavy use of 538's public NFL data.</span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>First some imports to get us running in a Jupyter notebook:</span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>Then we load the data, extract just the last few seasons, and run the desired stats:</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>box <span class="op">=</span> pd.read_csv(<span class="st">'https://raw.githubusercontent.com/fivethirtyeight/nfl-elo-game/master/data/nfl_games.csv'</span>)</span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a><span class="co"># convert date to datetime</span></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>box[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(box[<span class="st">'date'</span>])</span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a><span class="co"># grab since ____ season</span></span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>box <span class="op">=</span> (box[box[<span class="st">'date'</span>] <span class="op">&gt;</span> <span class="st">'2003-08-01'</span>]</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>       .reset_index()</span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>       .drop([<span class="st">'index'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>       .copy())</span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> box.shape[<span class="dv">0</span>]</span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a>elodiffs <span class="op">=</span> np.zeros(n)</span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>pdiffs   <span class="op">=</span> np.zeros(n)</span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, row <span class="kw">in</span> box.iterrows():</span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>    elodiffs[i] <span class="op">=</span> row[<span class="st">'elo1'</span>] <span class="op">-</span> row[<span class="st">'elo2'</span>] <span class="op">+</span> (<span class="dv">0</span> <span class="cf">if</span> row[<span class="st">'neutral'</span>]<span class="op">==</span><span class="dv">1</span> <span class="cf">else</span> <span class="dv">65</span>)</span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>    pdiffs[i]   <span class="op">=</span> row[<span class="st">'score1'</span>] <span class="op">-</span> row[<span class="st">'score2'</span>]</span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>We could do something like a <span class="in">`pdiffs`</span> vs. <span class="in">`elodiffs`</span> plot with Seaborn at this point, perhaps a <span class="in">`jointplot`</span> like this ...</span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>sns.jointplot(elodiffs <span class="op">/</span> <span class="dv">25</span>, pdiffs, ylim<span class="op">=</span>(<span class="op">-</span><span class="dv">50</span>,<span class="dv">50</span>), kind<span class="op">=</span><span class="st">'hex'</span>)</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>which is quite exciting.  But what we're really interested in is the mean MOV function distributions, which is the much less pretty:</span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">300</span>,<span class="dv">400</span>,<span class="dv">10</span>)</span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> g1(x):</span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">/</span><span class="dv">1000</span>) <span class="op">+</span> <span class="fl">2.2</span></span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> g2(x):</span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>x<span class="op">/</span><span class="dv">1000</span> <span class="op">+</span> <span class="fl">2.2</span></span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>ax.plot(ed, mw, <span class="st">'ko-'</span>, label<span class="op">=</span><span class="st">'Win'</span>)</span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>ax.plot(xs, g1(xs), <span class="st">'k--'</span>)</span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>ax.plot(ed, ml, <span class="st">'co-'</span>, label<span class="op">=</span><span class="st">'Loss'</span>)</span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a>ax.plot(xs, g2(xs), <span class="st">'c--'</span>)</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r'$R_i - R_j$'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r'Mean $M(z)$'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>